variables:
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: none

default:
    image: registry.gitlab.com/dpetrisko/black-parrot-sdk:latest

stages:
    - tools
    - perch
    - prog
    - publish

.job_template: &job_definition
  only:
    - pushes
  before_script:
    - make checkout -j $CI_NUM_CORES | tee checkout.log
  artifacts:
    when: always
    paths:
      - "*.log"
      - include/
      - lib/
      - install/
      - prog/
      - ucode/
    expire_in: "1 day"


build_bedrock:
  <<: *job_definition
  stage: tools
  script:
    - make bedrock -j1 | tee bedrock.log

build_dromajo:
  <<: *job_definition
  stage: tools
  script:
    - make dromajo | tee dromajo.log

build_gnudramfs:
  <<: *job_definition
  stage: tools
  script:
    - make gnudramfs | tee gnudramfs.log

build_perch:
  <<: *job_definition
  stage: perch
  script:
    - make perch | tee perch.log

build_bootrom:
  <<: *job_definition
  stage: prog
  script:
    - make bootrom | tee bootrom.log

build_bp-demos:
  <<: *job_definition
  stage: prog
  script:
    - make bp-demos | tee bp-demos.log

build_bp-tests:
  <<: *job_definition
  stage: prog
  script:
    - make bp-tests | tee bp-tests.log

build_riscv-tests:
  <<: *job_definition
  stage: prog
  script:
    - make riscv-tests | tee riscv-tests.log

build_coremark:
  <<: *job_definition
  stage: prog
  script:
    - make coremark | tee coremark.log

build_beebs:
  <<: *job_definition
  stage: prog
  script:
    - make beebs | tee beebs.log

zip_sdk:
  stage: publish
  script:
    - tar -czvf sdk.tar.gz include/ lib/ install/ | tee zip_sdk.log
  artifacts:
    when: on_success
    paths:
      - "*.log"
      - sdk.tar.gz
    expire_in: "1 day"

zip_prog:
  stage: publish
  script:
    - tar -czvf prog.tar.gz prog/ ucode/ | tee zip_prog.log
  artifacts:
    when: on_success
    paths:
      - "*.log"
      - prog.tar.gz

