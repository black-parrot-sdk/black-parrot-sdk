variables:
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: none

default:
  image: registry.gitlab.com/dpetrisko/black-parrot-sdk:latest

stages:
  - tools
  - perch
  - prog
  - zip
  - publish

.job_template: &job_definition
  only:
    - pushes
  before_script:
    - make checkout -j $CI_NUM_CORES | tee checkout.log
  artifacts:
    when: always
    paths:
      - "*.log"
      - include/
      - lib/
      - install/
      - prog/
      - ucode/
    expire_in: "1 day"

build_bedrock:
  <<: *job_definition
  stage: tools
  script:
    - make bedrock -j1 | tee bedrock.log

build_dromajo:
  <<: *job_definition
  stage: tools
  script:
    - make dromajo | tee dromajo.log

build_gnudramfs:
  <<: *job_definition
  stage: tools
  script:
    - make gnudramfs | tee gnudramfs.log

build_gnulinux:
  <<: *job_definition
  stage: tools
  script:
    - make gnulinux | tee gnulinux.log

build_perch:
  <<: *job_definition
  stage: perch
  script:
    - make perch | tee perch.log

build_bootrom:
  <<: *job_definition
  stage: prog
  script:
    - make bootrom | tee bootrom.log

build_bp-demos:
  <<: *job_definition
  stage: prog
  script:
    - make bp-demos | tee bp-demos.log

build_bp-tests:
  <<: *job_definition
  stage: prog
  script:
    - make bp-tests | tee bp-tests.log

build_riscv-tests:
  <<: *job_definition
  stage: prog
  script:
    - make riscv-tests | tee riscv-tests.log

build_coremark:
  <<: *job_definition
  stage: prog
  script:
    - make coremark | tee coremark.log

build_beebs:
  <<: *job_definition
  stage: prog
  script:
    - make beebs | tee beebs.log

zip_tools:
  stage: zip
  script:
    - tar -czvf tools.tar.gz include/ lib/ install/ | tee zip_tools.log
  artifacts:
    when: on_success
    paths:
      - "*.log"
      - tools.tar.gz
    expire_in: "1 day"
  dependencies:
    - build_bedrock
    - build_dromajo
    - build_gnudramfs
    - build_gnulinux

zip_prog:
  stage: zip
  script:
    - tar -czvf prog.tar.gz prog/ ucode/ | tee zip_prog.log
  artifacts:
    when: on_success
    paths:
      - "*.log"
      - prog.tar.gz
  dependencies:
    - build_bootrom
    - build_bp-demos
    - build_bp-tests
    - build_riscv-tests
    - build_coremark
    - build_beebs

publish_tag:
  stage: publish
  when: manual
  script:
    - gh config set prompt disabled
    - if [ "$CI_RELEASE_TAG" == "" ]; then echo "Please set CI_RELEASE_TAG"; exit 1; fi
    - gh release create $CI_RELEASE_TAG tools.tar.gz prog.tar.gz
  dependencies:
    - zip_tools
    - zip_prog

