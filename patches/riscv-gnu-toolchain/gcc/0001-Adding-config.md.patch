From 5c0e4057e87d9eb711b4e527c60c0ddcf27b9685 Mon Sep 17 00:00:00 2001
From: Dan Ruelas-Petrisko <petrisko@cs.washington.edu>
Date: Wed, 18 Jun 2025 22:57:43 -0700
Subject: [PATCH 1/2] Adding config.md

---
 gcc/config/riscv/bsg_blackparrot.md      | 60 ++++++++++++++++++++++++
 gcc/config/riscv/bsg_blackparrot_alt.md  | 45 ++++++++++++++++++
 gcc/config/riscv/bsg_blackparrot_alt2.md | 45 ++++++++++++++++++
 gcc/config/riscv/riscv.md                |  5 +-
 4 files changed, 154 insertions(+), 1 deletion(-)
 create mode 100644 gcc/config/riscv/bsg_blackparrot.md
 create mode 100644 gcc/config/riscv/bsg_blackparrot_alt.md
 create mode 100644 gcc/config/riscv/bsg_blackparrot_alt2.md

diff --git a/gcc/config/riscv/bsg_blackparrot.md b/gcc/config/riscv/bsg_blackparrot.md
new file mode 100644
index 00000000000..7bf47e53c67
--- /dev/null
+++ b/gcc/config/riscv/bsg_blackparrot.md
@@ -0,0 +1,60 @@
+(define_automaton "bsg_blackparrot")
+
+;; EXE stage functional units, FPU has 3-stage pipeline
+(define_cpu_unit "bsg_blackparrot_alu" "bsg_blackparrot")
+(define_cpu_unit "bsg_blackparrot_div" "bsg_blackparrot")
+
+(define_insn_reservation "bsg_blackparrot_alu" 1
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "unknown,arith,shift,slt,multi,logical,move,nop,auipc,const"))
+  "bsg_blackparrot_alu")
+
+(define_insn_reservation "bsg_blackparrot_branch" 1
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "branch"))
+  "bsg_blackparrot_alu")
+
+(define_insn_reservation "bsg_blackparrot_jump" 1
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "jump,call"))
+  "bsg_blackparrot_alu")
+
+(define_insn_reservation "bsg_blackparrot_iload" 2
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "load"))
+  "bsg_blackparrot_alu")
+
+(define_insn_reservation "bsg_blackparrot_fload" 3
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "fpload"))
+  "bsg_blackparrot_alu")
+
+(define_insn_reservation "bsg_blackparrot_store" 1
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "store,fpstore"))
+  "bsg_blackparrot_alu")
+
+(define_insn_reservation "bsg_blackparrot_imul" 4
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "imul"))
+  "bsg_blackparrot_alu")
+
+(define_insn_reservation "bsg_blackparrot_idiv" 66
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "idiv"))
+  "bsg_blackparrot_div*66")
+
+(define_insn_reservation "bsg_blackparrot_floats_aux" 2
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "fcvt,fcmp,fmove"))
+  "bsg_blackparrot_alu")
+
+(define_insn_reservation "bsg_blackparrot_floats_fma" 5
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "fadd,fmul,fmadd"))
+  "bsg_blackparrot_alu")
+
+(define_insn_reservation "bsg_blackparrot_floats_long" 55
+  (and (eq_attr "tune" "bsg_blackparrot")
+       (eq_attr "type" "fdiv,fsqrt"))
+  "bsg_blackparrot_div*55")
diff --git a/gcc/config/riscv/bsg_blackparrot_alt.md b/gcc/config/riscv/bsg_blackparrot_alt.md
new file mode 100644
index 00000000000..59c0503fb46
--- /dev/null
+++ b/gcc/config/riscv/bsg_blackparrot_alt.md
@@ -0,0 +1,45 @@
+(define_automaton "bsg_blackparrot_alt")
+
+;; EXE stage functional units, FPU has 3-stage pipeline
+(define_cpu_unit "bsg_blackparrot_alt_alu" "bsg_blackparrot_alt")
+(define_cpu_unit "bsg_blackparrot_alt_div" "bsg_blackparrot_alt")
+
+(define_insn_reservation "bsg_blackparrot_alt_alu" 1
+  (and (eq_attr "tune" "bsg_blackparrot_alt")
+       (eq_attr "type" "unknown,arith,shift,slt,multi,logical,move,nop,auipc,const"))
+  "bsg_blackparrot_alt_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt_branch" 1
+  (and (eq_attr "tune" "bsg_blackparrot_alt")
+       (eq_attr "type" "branch"))
+  "bsg_blackparrot_alt_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt_jump" 1
+  (and (eq_attr "tune" "bsg_blackparrot_alt")
+       (eq_attr "type" "jump,call"))
+  "bsg_blackparrot_alt_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt_load" 2
+  (and (eq_attr "tune" "bsg_blackparrot_alt")
+       (eq_attr "type" "load,fpload"))
+  "bsg_blackparrot_alt_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt_store" 1
+  (and (eq_attr "tune" "bsg_blackparrot_alt")
+       (eq_attr "type" "store,fpstore"))
+  "bsg_blackparrot_alt_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt_imul" 4
+  (and (eq_attr "tune" "bsg_blackparrot_alt")
+       (eq_attr "type" "imul"))
+  "bsg_blackparrot_alt_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt_idiv" 34
+  (and (eq_attr "tune" "bsg_blackparrot_alt")
+       (eq_attr "type" "idiv"))
+  "bsg_blackparrot_alt_div*34")
+
+(define_insn_reservation "bsg_blackparrot_alt_floats" 5
+  (and (eq_attr "tune" "bsg_blackparrot_alt")
+       (eq_attr "type" "fadd,fmul,fdiv,fcvt,fcmp,fmove"))
+  "bsg_blackparrot_alt_alu")
diff --git a/gcc/config/riscv/bsg_blackparrot_alt2.md b/gcc/config/riscv/bsg_blackparrot_alt2.md
new file mode 100644
index 00000000000..d50839edf6b
--- /dev/null
+++ b/gcc/config/riscv/bsg_blackparrot_alt2.md
@@ -0,0 +1,45 @@
+(define_automaton "bsg_blackparrot_alt2")
+
+;; EXE stage functional units, FPU has 3-stage pipeline
+(define_cpu_unit "bsg_blackparrot_alt2_alu" "bsg_blackparrot_alt2")
+(define_cpu_unit "bsg_blackparrot_alt2_div" "bsg_blackparrot_alt2")
+
+(define_insn_reservation "bsg_blackparrot_alt2_alu" 1
+  (and (eq_attr "tune" "bsg_blackparrot_alt2")
+       (eq_attr "type" "unknown,arith,shift,slt,multi,logical,move,nop,auipc,const"))
+  "bsg_blackparrot_alt2_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt2_branch" 1
+  (and (eq_attr "tune" "bsg_blackparrot_alt2")
+       (eq_attr "type" "branch"))
+  "bsg_blackparrot_alt2_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt2_jump" 1
+  (and (eq_attr "tune" "bsg_blackparrot_alt2")
+       (eq_attr "type" "jump,call"))
+  "bsg_blackparrot_alt2_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt2_load" 3
+  (and (eq_attr "tune" "bsg_blackparrot_alt2")
+       (eq_attr "type" "load,fpload"))
+  "bsg_blackparrot_alt2_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt2_store" 1
+  (and (eq_attr "tune" "bsg_blackparrot_alt2")
+       (eq_attr "type" "store,fpstore"))
+  "bsg_blackparrot_alt2_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt2_imul" 4
+  (and (eq_attr "tune" "bsg_blackparrot_alt2")
+       (eq_attr "type" "imul"))
+  "bsg_blackparrot_alt2_alu")
+
+(define_insn_reservation "bsg_blackparrot_alt2_idiv" 34
+  (and (eq_attr "tune" "bsg_blackparrot_alt2")
+       (eq_attr "type" "idiv"))
+  "bsg_blackparrot_alt2_div*34")
+
+(define_insn_reservation "bsg_blackparrot_alt2_floats" 5
+  (and (eq_attr "tune" "bsg_blackparrot_alt2")
+       (eq_attr "type" "fadd,fmul,fdiv,fcvt,fcmp,fmove"))
+  "bsg_blackparrot_alt2_alu")
diff --git a/gcc/config/riscv/riscv.md b/gcc/config/riscv/riscv.md
index 26a247c2b96..12c4d5d9d66 100644
--- a/gcc/config/riscv/riscv.md
+++ b/gcc/config/riscv/riscv.md
@@ -662,21 +662,21 @@
 	  (eq_attr "move_type" "store,fpstore")
 	  (symbol_ref "riscv_load_store_insns (operands[0], insn) * 4")
 	  ] (const_int 4)))
 
 ;; Is copying of this instruction disallowed?
 (define_attr "cannot_copy" "no,yes" (const_string "no"))
 
 ;; Microarchitectures we know how to tune for.
 ;; Keep this in sync with enum riscv_microarchitecture.
 (define_attr "tune"
-  "generic,sifive_7,sifive_p400,sifive_p600,xiangshan,generic_ooo"
+  "generic,sifive_7,sifive_p400,sifive_p600,xiangshan,generic_ooo,bsg_blackparrot,bsg_blackparrot_alt,bsg_blackparrot_alt2"
   (const (symbol_ref "((enum attr_tune) riscv_microarchitecture)")))
 
 ;; Describe a user's asm statement.
 (define_asm_attributes
   [(set_attr "type" "multi")])
 
 ;; Ghost instructions produce no real code and introduce no hazards.
 ;; They exist purely to express an effect on dataflow.
 (define_insn_reservation "ghost" 0
   (eq_attr "type" "ghost")
@@ -4821,10 +4821,13 @@
 (include "generic-vector-ooo.md")
 (include "generic-ooo.md")
 (include "vector.md")
 (include "vector-crypto.md")
 (include "vector-bfloat16.md")
 (include "zicond.md")
 (include "sfb.md")
 (include "zc.md")
 (include "corev.md")
 (include "xiangshan.md")
+(include "bsg_blackparrot.md")
+(include "bsg_blackparrot_alt.md")
+(include "bsg_blackparrot_alt2.md")
-- 
2.18.4

